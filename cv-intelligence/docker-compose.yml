version: '3.8'

# CV Intelligence - Docker Compose Configuration
# For laptop testing and production deployment
#
# Usage:
#   # Start services
#   docker-compose up -d
#
#   # View logs
#   docker-compose logs -f
#
#   # Stop services
#   docker-compose down
#
#   # Stop and remove volumes (deletes data!)
#   docker-compose down -v

services:
  # Redis - Job queue for distributed processing
  redis:
    image: redis:7-alpine
    container_name: cv-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Qdrant - Vector database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: cv-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"  # HTTP API and Dashboard
      - "6334:6334"  # gRPC API (optional, for better performance)
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      # Optional: Uncomment to enable API key authentication
      # - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY:-}

      # Performance tuning (optional)
      # - QDRANT__STORAGE__ON_DISK_PAYLOAD=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# Named volumes for data persistence
volumes:
  redis_data:
    driver: local
  qdrant_storage:
    driver: local

# Note: The application (app.py) and worker (worker.py) run on the host
# for development. For production deployment, uncomment the sections below.

# Uncomment for production deployment:
#
#   app:
#     build: .
#     container_name: cv-app
#     restart: unless-stopped
#     ports:
#       - "8501:8501"
#     depends_on:
#       - qdrant
#       - redis
#     environment:
#       - QDRANT_URL=http://qdrant:6333
#       - REDIS_URL=redis://redis:6379
#       - USE_LOCAL_QDRANT=false
#       - USE_LOCAL_EMBEDDINGS=true
#       - LOCAL_EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
#       - EMBEDDING_DEVICE=cpu
#     volumes:
#       - ./data:/app/data
#
#   worker:
#     build: .
#     container_name: cv-worker
#     command: python worker.py
#     restart: unless-stopped
#     depends_on:
#       - qdrant
#       - redis
#     environment:
#       - QDRANT_URL=http://qdrant:6333
#       - REDIS_URL=redis://redis:6379
#       - USE_LOCAL_QDRANT=false
#       - USE_LOCAL_EMBEDDINGS=true
#       - LOCAL_EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
#       - EMBEDDING_DEVICE=cpu
#     volumes:
#       - ./data:/app/data
#     deploy:
#       replicas: 1  # Increase for parallel processing
